---
layout: post
title: Cambios en IPN de Paypal del 7 de Octubre
date: '2013-10-03T11:03:00.001+02:00'
author: Miguel González
tags:
- ipn
- paypal
- programación
- webmasters
- php
modified_time: '2013-10-13T23:11:13.838+02:00'
blogger_id: tag:blogger.com,1999:blog-8588071933588851396.post-251229994165962135
blogger_orig_url: http://www.miguelg.com/2013/10/cambios-en-ipn-de-paypal-del-7-de.html
---

Paypal hace un cambio en su sistema al ampliar más IPs a su servicio y aprovecha para hacer un cambio en la comunicación con sus servidores migrando de HTTP/1.0 a HTTP/1.1, esto tiene repercusión en las webs que tengan integrado el servicio de <i>Instant Payment Notification</i>, o IPN.<br /><br />En el email que notifican del cambio añaden unos códigos de ejemplo de como realizar el cambio, si os limitáis a copiar y pegar este extracto el IPN no va a funcionar, pues según la implementación que tengas requiere más cambios.<br /><br />Se requiere en un principio añadir el "Host: www.paypal.com" y el "Connection: Close". Hasta ahí todo bien, pero si tienes indicado el <b>content lenght</b> en las cabeceras, tienes que enviarlo debajo del connection: close y no antes.<br /><br />Los headers quedarían de la siguiente manera:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span><br /><div class="line" id="LC26"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv">$header</span> <span class="o">=</span> <span class="s2">"POST /cgi-bin/webscr HTTP/1.1</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></span></span></div><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span><div class="line" id="LC27"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Content-Type: application/x-www-form-urlencoded</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></span></span></div><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><div class="line" id="LC28"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Host: www.paypal.com</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></span></div><div class="line" id="LC29"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Connection: close</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span></span></div><div class="line" id="LC30"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv">$header</span> <span class="o">.=</span> <span class="s2">"Content-Length: "</span> <span class="o">.</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$req</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\r\n\r\n</span><span class="s2">"</span><span class="p">;</span></span></div></span><br /><br />Después, en el momento de recuperar los datos del servidor de Paypal, hay algo que no mencionan y que es importante, hay que aplicar un trim a el contenido recibido. En la parte donde se recupera el contenido debe quedar de la siguiente manera:<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv">$res</span> <span class="o">=</span> <span class="nb">fgets</span> <span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span></span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span class="nv"><br />$res</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span> <span class="c1">// Importante!</span></span><br /><pre><div class="line" id="LC88"><br /></div><br /></pre>Con estos dos cambios deberias de estar preparado para el cambio. 